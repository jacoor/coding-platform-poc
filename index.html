<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PyMasters Platform</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/languages/python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.0/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.0/mode-python.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.23.0/theme-monokai.js"></script>
    <style>
        :root {
            --primary-color: #23afd0;
            --secondary-color: #1d2733;
            --bg-color: #1a222d;
            --text-color: #ffffff;
            --accent-color: #31b9d8;
            --border-color: #2c3a4a;
            --success-color: #27ae60;
            --failure-color: #e74c3c;
            --warning-color: #f1c40f;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }
        
        header {
            background-color: var(--secondary-color);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--border-color);
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--primary-color);
            font-weight: bold;
            font-size: 1.5rem;
        }
        
        .logo-icon {
            color: var(--primary-color);
            font-size: 2rem;
        }
        
        nav {
            display: flex;
            gap: 1.5rem;
        }
        
        nav a {
            color: var(--text-color);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        nav a:hover {
            color: var(--primary-color);
        }
        
        .btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background-color: var(--accent-color);
        }
        
        main {
            padding: 1.5rem;
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 1.5rem;
        }
        
        .main-content {
            grid-column: 1;
        }
        
        .ai-sidebar {
            grid-column: 2;
            background-color: var(--secondary-color);
            border-radius: 8px;
            padding: 1rem;
            height: calc(100vh - 150px);
            position: sticky;
            top: 1.5rem;
            display: flex;
            flex-direction: column;
        }
        
        .lesson-title {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: var(--text-color);
        }
        
        .lesson-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .badge {
            background-color: #364151;
            padding: 0.25rem 0.75rem;
            border-radius: 100px;
            font-size: 0.8rem;
        }
        
        .lesson-description {
            margin-bottom: 2rem;
            line-height: 1.6;
        }
        
        .video-container {
            width: 100%;
            background-color: #151d28;
            border-radius: 6px;
            overflow: hidden;
            margin-bottom: 2rem;
            text-align: center;
            padding: 2rem;
            box-sizing: border-box;
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        
        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            background: none;
            border: none;
            color: var(--text-color);
            font-weight: bold;
            transition: background-color 0.3s;
        }
        
        .tab.active {
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
        }
        
        .tab:hover:not(.active) {
            background-color: #2a384a;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .code-editor {
            border-radius: 6px;
            overflow: hidden;
            height: 300px;
            border: 1px solid var(--border-color);
            margin-bottom: 1rem;
        }
        
        .editor-controls {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        
        .task-description {
            background-color: #283544;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary-color);
        }
        
        .test-output {
            background-color: #1e2b3a;
            padding: 1rem;
            border-radius: 6px;
            margin-top: 1rem;
            white-space: pre-wrap;
            font-family: monospace;
        }
        
        .function-spec {
            background-color: #283544;
            padding: 1rem;
            border-radius: 6px;
            margin-bottom: 1.5rem;
        }
        
        .function-spec code {
            background-color: #1e2b3a;
            padding: 0.2rem 0.4rem;
            border-radius: 3px;
        }
        
        .assistant-container {
            background-color: #283544;
            border-radius: 6px;
            padding: 1rem;
            margin-top: 2rem;
        }
        
        .assistant-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .assistant-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        .assistant-content {
            line-height: 1.6;
        }
        
        .hidden {
            display: none;
        }
        
        .test-result {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            border-radius: 4px;
        }
        
        .test-success {
            background-color: rgba(39, 174, 96, 0.2);
            border-left: 4px solid var(--success-color);
        }
        
        .test-failure {
            background-color: rgba(231, 76, 60, 0.2);
            border-left: 4px solid var(--failure-color);
        }
        
        .lint-error {
            background-color: rgba(241, 196, 15, 0.2);
            border-left: 4px solid var(--warning-color);
        }

        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid var(--primary-color);
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: inline-block;
            margin-right: 10px;
            vertical-align: middle;
        }
        
        .test-status {
            font-weight: bold;
            display: inline-block;
            width: 70px;
            text-align: center;
            padding: 2px 4px;
            border-radius: 3px;
            margin-right: 10px;
        }
        
        .status-pass {
            background-color: var(--success-color);
            color: white;
        }
        
        .status-fail {
            background-color: var(--failure-color);
            color: white;
        }

        /* Czat AI */
        .chat-title {
            color: var(--primary-color);
            margin-top: 0;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .chat-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            margin-bottom: 1rem;
            background-color: rgba(26, 34, 45, 0.5);
            border-radius: 6px;
            padding: 1rem;
        }
        
        .chat-message {
            margin-bottom: 1rem;
            padding: 0.5rem;
            border-radius: 6px;
        }
        
        .message-user {
            background-color: rgba(35, 175, 208, 0.2);
            align-self: flex-end;
            margin-left: 20%;
        }
        
        .message-ai {
            background-color: rgba(44, 58, 74, 0.5);
            align-self: flex-start;
            margin-right: 20%;
        }
        
        .chat-input-container {
            display: flex;
            gap: 0.5rem;
        }
        
        .chat-input {
            flex-grow: 1;
            background-color: #283544;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 0.5rem;
            color: var(--text-color);
            resize: none;
        }
        
        .chat-send {
            align-self: flex-end;
        }
        
        .chat-placeholder {
            text-align: center;
            opacity: 0.7;
            margin-top: 2rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        footer {
            background-color: var(--secondary-color);
            padding: 1.5rem;
            text-align: center;
            margin-top: 3rem;
            border-top: 1px solid var(--border-color);
        }
        
        /* API Key Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
        }
        
        .modal-content {
            background-color: var(--secondary-color);
            margin: 15% auto;
            padding: 20px;
            border-radius: 8px;
            max-width: 500px;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        
        .close {
            color: var(--text-color);
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        
        .modal-body {
            margin-bottom: 1rem;
        }
        
        .api-key-input {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.5rem;
            background-color: #1a222d;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
        }
        
        .api-key-info {
            font-size: 0.8rem;
            margin-top: 0.5rem;
            color: #aaa;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }
        
        .ai-provider-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .provider-option {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .provider-option.selected {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        .api-mode-selector {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }
        
        .mode-option {
            padding: 0.5rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .mode-option.selected {
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }
        
        /* Responsywność */
        @media (max-width: 992px) {
            main {
                grid-template-columns: 1fr;
            }
            
            .main-content, .ai-sidebar {
                grid-column: 1;
            }
            
            .ai-sidebar {
                height: 400px;
                position: static;
            }
        }
        /* Style dla formatowania kodu w czacie */
        .ai-content {
            line-height: 1.6;
        }
        .code-block {
            margin: 10px 0;
            background-color: #1e2b3a;
            border-radius: 6px;
            overflow: hidden;
        }
        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #2c3a4a;
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        .copy-btn {
            background-color: var(--primary-color);
            color: white;
            border: none;
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .copy-btn:hover {
            background-color: var(--accent-color);
        }
        .code-block pre {
            margin: 0;
            padding: 10px;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
        }
        .code-block code {
            font-family: monospace;
        }
        .ai-sidebar.fullscreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    z-index: 1001;
    border-radius: 0;
    padding: 2rem;
}

.ai-sidebar.fullscreen .chat-container {
    max-width: 1200px;
    margin: 0 auto;
    height: 100%;
}

.ai-sidebar.fullscreen .chat-messages {
    height: calc(100% - 150px);
}

/* Dodaj te style w sekcji <style> */
    .code-block {
    margin: 15px 0;
    background-color: #1e2b3a;
    border-radius: 6px;
    overflow: hidden;
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    background-color: #2c3a4a;
    padding: 8px 12px;
    font-size: 0.9rem;
    color: #c4d3e0;
}

.code-block pre {
    margin: 0;
    padding: 15px;
    white-space: pre;
    overflow-x: auto;
    background-color: #1a222d;
    border-top: 1px solid #303e4d;
}

.code-block code {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    font-size: 14px;
    line-height: 1.5;
    tab-size: 4;
}

/* Style dla podświetlania składni w blokach kodu */
.code-block {
    margin: 15px 0;
    background-color: #1a222d;
    border-radius: 6px;
    overflow: hidden;
    font-family: monospace;
}

.code-header {
    background-color: #2c3a4a;
    padding: 8px 12px;
    color: #c4d3e0;
    font-size: 0.9rem;
}

.code-block pre {
    margin: 0;
    padding: 12px;
    overflow-x: auto;
    white-space: pre !important;
    tab-size: 4;
    line-height: 1.5;
}

.code-block code {
    font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
    display: block;
    white-space: pre !important;
}
.close-fullscreen {
    position: absolute;
    top: 15px;
    right: 15px;
    background-color: var(--primary-color);
    color: white;
    border: none;
    border-radius: 10px;
    /* width: 40px; */
    height: 40px;
    font-size: 20px;
    cursor: pointer;
    display: none;
    z-index: 10;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
}

.ai-sidebar.fullscreen .close-fullscreen {
    display: block;
}

.close-fullscreen:hover {
    background-color: var(--accent-color);
}
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <span class="logo-icon">&#9672;</span> PyMasters Platform
        </div>
        <nav>
            <a href="#">Lekcje</a>
            <a href="#">Ścieżki</a>
            <a href="#">Społeczność</a>
            <a href="#">Pomoc</a>
        </nav>
        <button class="btn hidden" id="api-key-btn">Ustaw API</button>
    </header>
    
    <main>
        <div class="main-content">
            <h1 class="lesson-title">Manipulacja tekstem - Odwracanie wokalizacji</h1>
            <div class="lesson-meta">
                <span class="badge">Poziom: Początkujący</span>
                <span class="badge">Punkty: 5</span>
            </div>
            
            <div class="lesson-description">
                <p>W tej lekcji nauczysz się pisać funkcję, która manipuluje tekstem według określonych reguł. To doskonały sposób na ćwiczenie pracy z łańcuchami znaków w Pythonie i zrozumienie zasad przetwarzania tekstu.</p>
            </div>
            
            <div class="video-container">
                <iframe width="560" height="315" src="https://www.youtube.com/embed/G34v72WBjms" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
            </div>
            
            <div class="task-description">
                <h3>Zadanie: Odwracanie wokalizacji</h3>
                <p>Napisz funkcję, która przetwarza tekst według następujących zasad:</p>
                <ul>
                    <li>Wszystkie samogłoski (a, e, i, o, u) muszą być zamienione na wielkie litery</li>
                    <li>Wszystkie spółgłoski muszą być zamienione na małe litery</li>
                    <li>Znaki interpunkcyjne powinny zostać usunięte</li>
                    <li>Spacje powinny pozostać nienaruszone</li>
                    <li>Jeśli przetwarzany jest plik, rozszerzenie pliku nie powinno być modyfikowane</li>
                </ul>
            </div>
            
            <div class="function-spec">
                <h3>Specyfikacja funkcji:</h3>
                <p>Funkcja <code>odwroc_wokalizacje</code> przyjmuje albo <code>string</code> albo <code>nazwę_pliku</code> i zwraca <code>string</code> z samogłoskami zamienionymi na wielkie litery.</p>
                <p>Parametry:</p>
                <ul>
                    <li><code>text: str</code> - tekst do przetworzenia lub nazwa pliku</li>
                </ul>
                <p>Zwraca:</p>
                <ul>
                    <li><code>str</code> - Przekształcony tekst</li>
                </ul>
            </div>
            
            <div class="tabs">
                <button class="tab active" data-tab="code">Kod</button>
                <button class="tab" data-tab="tests">Testy</button>
            </div>
            
            <div id="code-tab" class="tab-content active">
                <div id="editor" class="code-editor">SAMOGLOSKI = "aeiou"
ROZSZERZENIA = [".mp3", ".jpg", ".jpeg", ".pdf", ".txt", ".mp4", ".png", ".exe"]

def odwroc_wokalizacje(text: str) -> str:
    """
    Przetwarza tekst zamieniając samogłoski na wielkie litery,
    spółgłoski na małe litery i usuwając znaki interpunkcyjne.
    
    Args:
        text: Tekst do przetworzenia lub nazwa pliku
        
    Returns:
        Przetworzony tekst
    """
    # Twój kod tutaj
    pass</div>
                
                <div class="editor-controls">
                    <button class="btn" id="run-code">Uruchom</button>
                    <button class="btn" id="lint-code">Lint</button>
                </div>
                
                <div id="output" class="test-output hidden"></div>
            </div>
            
            <div id="tests-tab" class="tab-content">
                <h3>Przykładowe testy:</h3>
                <div id="tests-editor" class="code-editor">import unittest

class TestOdwrocWokalizacje(unittest.TestCase):
    def test_basic_functionality(self):
        self.assertEqual(odwroc_wokalizacje("Hello, World!"), "hEllO wOrld")
        
    def test_numbers_and_specials(self):
        self.assertEqual(odwroc_wokalizacje("Python 3.9"), "pythOn 39")
        
    def test_file_extension(self):
        self.assertEqual(odwroc_wokalizacje("example.txt"), "ExAmplE.txt")
        
    def test_uppercase(self):
        self.assertEqual(odwroc_wokalizacje("UPPERCASE"), "UppErcAsE")
        
    def test_lowercase(self):
        self.assertEqual(odwroc_wokalizacje("lowercase"), "lOwErcAsE")
        
    def test_mixed_case(self):
        self.assertEqual(odwroc_wokalizacje("Mixed-Case!"), "mIxEdcAsE")</div>
                
                <p>Powyższe testy są publiczne. Istnieją również ukryte testy, które sprawdzą dodatkowe przypadki.</p>
                
                <button class="btn" id="run-tests">Uruchom testy</button>
                
                <div id="test-output" class="test-output hidden"></div>
            </div>
            
            <div class="assistant-container">
                <div class="assistant-header">
                    <div class="assistant-avatar">AI</div>
                    <h3>Analiza rozwiązania</h3>
                </div>
                <div class="assistant-content" id="ai-review-content">
                    <p>Witaj! Jestem twoim AI asystentem. Uruchom swój kod, a przeanalizuję twoje rozwiązanie.</p>
                    <p>Możesz także zadawać mi pytania w czacie po prawej stronie.</p>
                </div>
            </div>
        </div>
        
        <div class="ai-sidebar">
            <div class="chat-container">
                <h3 class="chat-title">
                    <div class="assistant-avatar">AI</div>
                    Czat z asystentem
                </h3>
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message message-ai">
                        <p>Witaj! Jestem twoim AI asystentem Python. Możesz zadawać mi pytania dotyczące zadania lub poprosić o pomoc z kodem.</p>
                    </div>
                    <div class="chat-placeholder" id="chat-placeholder">
                        <p>Podłącz swój klucz API, aby korzystać z AI asystenta</p>
                    </div>
                </div>
                <div class="chat-input-container">
                    <textarea class="chat-input" id="chat-input" placeholder="Napisz wiadomość..." rows="3"></textarea>
                    <button class="btn chat-send" id="chat-send">Wyślij</button>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Modal do wprowadzania klucza API -->
    <div id="api-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ustaw klucz API</h2>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <p>Wybierz dostawcę AI:</p>
                <div class="ai-provider-selector">
                    <div class="provider-option selected" data-provider="anthropic">Anthropic (Claude)</div>
                    <div class="provider-option" data-provider="openai">OpenAI</div>
                </div>
                
                <p>Wybierz tryb:</p>
                <div class="api-mode-selector">
                    <div class="mode-option selected" data-mode="proxy">Proxy PHP</div>
                    <div class="mode-option" data-mode="direct">Bezpośrednie API</div>
                </div>
                
                <div id="openai-api-settings" class="hidden">
                    <label for="openai-api-key">Klucz API OpenAI:</label>
                    <input type="password" id="openai-api-key" class="api-key-input" placeholder="sk-...">
                    <p class="api-key-info">Klucz możesz uzyskać na <a href="https://platform.openai.com/api-keys" target="_blank">platform.openai.com/api-keys</a></p>
                </div>
                
                <div id="anthropic-api-settings">
                    <label for="anthropic-api-key">Klucz API Anthropic:</label>
                    <input type="password" id="anthropic-api-key" class="api-key-input" placeholder="sk-ant-...">
                    <p class="api-key-info">Klucz możesz uzyskać na <a href="https://console.anthropic.com/keys" target="_blank">console.anthropic.com/keys</a></p>
                </div>
                
                <div id="proxy-settings" class="hidden">
                    <label for="proxy-url">URL Proxy:</label>
                    <input type="text" id="proxy-url" class="api-key-input" placeholder="https://pymasters.pl/platforma-kodowa-poc/index.php" value="https://pymasters.pl/platforma-kodowa-poc/index.php">
                    <p class="api-key-info">Adres URL do skryptu proxy PHP na Twoim serwerze</p>
                </div>
                
                <p class="api-key-info">Twój klucz API jest przechowywany tylko lokalnie w przeglądarce i nie jest nigdzie wysyłany poza bezpośrednią komunikacją z API.</p>
            </div>
            <div class="modal-footer">
                <button class="btn" id="test-connection">Test połączenia</button>
                <button class="btn" id="cancel-api-key">Anuluj</button>
                <button class="btn" id="save-api-key">Zapisz</button>
            </div>
        </div>
    </div>
    
    <footer>
        <p>&copy; 2025 PyMasters Platform. Wszystkie prawa zastrzeżone.</p>
    </footer>
    
    <script>
        // Inicjalizacja edytorów kodu
        const editor = ace.edit("editor");
        editor.setTheme("ace/theme/monokai");
        editor.session.setMode("ace/mode/python");
        editor.setFontSize(14);
        
        const testsEditor = ace.edit("tests-editor");
        testsEditor.setTheme("ace/theme/monokai");
        testsEditor.session.setMode("ace/mode/python");
        testsEditor.setFontSize(14);
        testsEditor.setReadOnly(true);  // Testy są tylko do odczytu
        
        // Obsługa zakładek
        const tabs = document.querySelectorAll('.tab');
        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                tabs.forEach(t => t.classList.remove('active'));
                tab.classList.add('active');
                
                const tabId = tab.getAttribute('data-tab');
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId + '-tab').classList.add('active');
            });
        });
        
        // Zmienne dotyczące API AI
        let aiProvider = localStorage.getItem('aiProvider') || 'anthropic';
        let apiMode = localStorage.getItem('apiMode') || 'proxy';
        let apiKey = {
            openai: localStorage.getItem('openaiApiKey') || '',
            anthropic: localStorage.getItem('anthropicApiKey') || ''
        };
        let proxyUrl = localStorage.getItem('proxyUrl') || 'https://pymasters.pl/platforma-kodowa-poc/index.php';
        
        // Obsługa modalu API
        const apiModal = document.getElementById('api-modal');
        const apiKeyBtn = document.getElementById('api-key-btn');
        const closeBtn = document.querySelector('.close');
        const saveApiKeyBtn = document.getElementById('save-api-key');
        const cancelApiKeyBtn = document.getElementById('cancel-api-key');
        const testConnectionBtn = document.getElementById('test-connection');
        const providerOptions = document.querySelectorAll('.provider-option');
        const modeOptions = document.querySelectorAll('.mode-option');
        const openaiSettings = document.getElementById('openai-api-settings');
        const anthropicSettings = document.getElementById('anthropic-api-settings');
        const proxySettings = document.getElementById('proxy-settings');
        const openaiApiKeyInput = document.getElementById('openai-api-key');
        const anthropicApiKeyInput = document.getElementById('anthropic-api-key');
        const proxyUrlInput = document.getElementById('proxy-url');
        const chatPlaceholder = document.getElementById('chat-placeholder');
        
        // Wyświetlanie/ukrywanie elementów w zależności od API
        function updateApiKeyStatus() {
            const useProxy = apiMode === 'proxy';
            
            // Pokaż placeholder w czacie tylko jeśli nie ma klucza lub proxy URL
            if ((useProxy && proxyUrl) || (!useProxy && apiKey[aiProvider])) {
                chatPlaceholder.classList.add('hidden');
                document.getElementById('chat-input').disabled = false;
                document.getElementById('chat-send').disabled = false;
            } else {
                chatPlaceholder.classList.remove('hidden');
                document.getElementById('chat-input').disabled = true;
                document.getElementById('chat-send').disabled = true;
            }
        }
        
        // Inicjalizacja modalu API
        function initApiModal() {
            openaiApiKeyInput.value = apiKey.openai;
            anthropicApiKeyInput.value = apiKey.anthropic;
            proxyUrlInput.value = proxyUrl;
            
            // Zaznacz wybranego dostawcę
            providerOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-provider') === aiProvider) {
                    option.classList.add('selected');
                }
            });
            
            // Zaznacz wybrany tryb
            modeOptions.forEach(option => {
                option.classList.remove('selected');
                if (option.getAttribute('data-mode') === apiMode) {
                    option.classList.add('selected');
                }
            });
            
            // Pokaż/ukryj odpowiednie pola
            updateSettingsVisibility();
        }
        
        // Aktualizacja widoczności pól w zależności od wybranego dostawcy i trybu
        function updateSettingsVisibility() {
            const useProxy = apiMode === 'proxy';
            
            // Najpierw ukryj wszystkie pola
            openaiSettings.classList.add('hidden');
            anthropicSettings.classList.add('hidden');
            proxySettings.classList.add('hidden');
            
            // Potem pokaż odpowiednie
            if (useProxy) {
                proxySettings.classList.remove('hidden');
            } else {
                if (aiProvider === 'openai') {
                    openaiSettings.classList.remove('hidden');
                } else {
                    anthropicSettings.classList.remove('hidden');
                }
            }
        }
        
        // Otwórz modal API
        apiKeyBtn.addEventListener('click', () => {
            initApiModal();
            apiModal.style.display = 'block';
        });
        
        // Zamknij modal
        closeBtn.addEventListener('click', () => {
            apiModal.style.display = 'none';
        });
        
        cancelApiKeyBtn.addEventListener('click', () => {
            apiModal.style.display = 'none';
        });
        
        // Kliknięcie poza modalem
        window.addEventListener('click', (event) => {
            if (event.target === apiModal) {
                apiModal.style.display = 'none';
            }
        });
        
        // Wybór dostawcy AI
        providerOptions.forEach(option => {
            option.addEventListener('click', () => {
                providerOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                aiProvider = option.getAttribute('data-provider');
                updateSettingsVisibility();
            });
        });
        
        // Wybór trybu API
        modeOptions.forEach(option => {
            option.addEventListener('click', () => {
                modeOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                apiMode = option.getAttribute('data-mode');
                updateSettingsVisibility();
            });
        });
        
        // Test połączenia
        testConnectionBtn.addEventListener('click', async () => {
            // Tymczasowo pobierz wartości z inputów
            const tempProvider = aiProvider;
            const tempMode = apiMode;
            const tempProxyUrl = proxyUrlInput.value.trim();
            const tempApiKeys = {
                openai: openaiApiKeyInput.value.trim(),
                anthropic: anthropicApiKeyInput.value.trim()
            };
            
            testConnectionBtn.disabled = true;
            testConnectionBtn.textContent = 'Testowanie...';
            
            try {
                let result;
                
                if (tempMode === 'proxy') {
                    // Test połączenia przez proxy
                    result = await testProxyConnection(tempProxyUrl, tempProvider);
                } else {
                    // Test bezpośredniego połączenia z API
                    result = await testDirectConnection(tempProvider, tempApiKeys[tempProvider]);
                }
                
                if (result.success) {
                    alert('Połączenie działa poprawnie! ' + result.message);
                } else {
                    alert('Błąd połączenia: ' + result.message);
                }
            } catch (error) {
                alert('Wystąpił błąd: ' + error.message);
            } finally {
                testConnectionBtn.disabled = false;
                testConnectionBtn.textContent = 'Test połączenia';
            }
        });
        
        // Test połączenia bezpośrednio z API
        async function testDirectConnection(provider, key) {
            try {
                if (!key) {
                    return { success: false, message: 'Brak klucza API' };
                }
                
                if (provider === 'anthropic') {
                    const response = await fetch('https://api.anthropic.com/v1/messages', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'x-api-key': key,
                            'anthropic-version': '2023-06-01'
                        },
                        body: JSON.stringify({
                            model: "claude-3-7-sonnet-20250219",
                            max_tokens: 50,
                            messages: [
                                {role: "user", content: "Odpowiedz krótko: Test połączenia z Claude API działa?"}
                            ]
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        return { success: false, message: data.error.message || 'Błąd API' };
                    }
                    
                    return { success: true, message: 'Odpowiedź z Claude: ' + data.content[0].text.substring(0, 30) + '...' };
                } else if (provider === 'openai') {
                    const response = await fetch('https://api.openai.com/v1/chat/completions', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${key}`
                        },
                        body: JSON.stringify({
                            model: "gpt-3.5-turbo",
                            messages: [
                                {role: "user", content: "Odpowiedz krótko: Test połączenia z OpenAI API działa?"}
                            ],
                            max_tokens: 50
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        return { success: false, message: data.error.message || 'Błąd API' };
                    }
                    
                    return { success: true, message: 'Odpowiedź z OpenAI: ' + data.choices[0].message.content.substring(0, 30) + '...' };
                }
                
                return { success: false, message: 'Nieznany dostawca API' };
            } catch (error) {
                console.error('Error testing direct connection:', error);
                return { success: false, message: error.message };
            }
        }
        
        // Test połączenia przez proxy
        async function testProxyConnection(proxyUrl, provider) {
            try {
                if (!proxyUrl) {
                    return { success: false, message: 'Brak adresu URL proxy' };
                }
                
                let payload;
                if (provider === 'anthropic') {
                    payload = {
                        model: "claude-3-7-sonnet-20250219",
                        max_tokens: 50,
                        messages: [
                            {role: "user", content: "Odpowiedz krótko: Test połączenia z proxy działa?"}
                        ]
                    };
                } else {
                    payload = {
                        model: "gpt-3.5-turbo",
                        messages: [
                            {role: "user", content: "Odpowiedz krótko: Test połączenia z proxy działa?"}
                        ],
                        max_tokens: 50
                    };
                }
                
                const response = await fetch(proxyUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ provider: provider, payload: payload })
                });
                
                if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('Przekroczono limit zapytań. To platforma testowa. Wróć za parę godzin.');
                        }
                        throw new Error(`HTTP error: ${response.status}`);
                    }

                
                const data = await response.json();
                
                if (data.error) {
                    return { success: false, message: data.error };
                }
                
                let message;
                if (provider === 'anthropic' && data.content && data.content[0]) {
                    message = 'Odpowiedź z proxy: ' + data.content[0].text.substring(0, 30) + '...';
                } else if (provider === 'openai' && data.choices && data.choices[0]) {
                    message = 'Odpowiedź z proxy: ' + data.choices[0].message.content.substring(0, 30) + '...';
                } else {
                    message = 'Otrzymano odpowiedź z proxy, ale w nieoczekiwanym formacie';
                }
                
                return { success: true, message: message };
            } catch (error) {
                console.error('Error testing proxy connection:', error);
                return { success: false, message: error.message };
            }
        }
        
        // Zapisz klucz API
        saveApiKeyBtn.addEventListener('click', () => {
            apiKey.openai = openaiApiKeyInput.value.trim();
            apiKey.anthropic = anthropicApiKeyInput.value.trim();
            proxyUrl = proxyUrlInput.value.trim();
            
            localStorage.setItem('aiProvider', aiProvider);
            localStorage.setItem('apiMode', apiMode);
            localStorage.setItem('openaiApiKey', apiKey.openai);
            localStorage.setItem('anthropicApiKey', apiKey.anthropic);
            localStorage.setItem('proxyUrl', proxyUrl);
            
            updateApiKeyStatus();
            apiModal.style.display = 'none';
        });
        
        // Funkcja do przesyłania kodu do Judge0 API
        async function submitToJudge0(code, language_id = 71) {  // 71 to ID dla Pythona 3
            const encodedCode = btoa(unescape(encodeURIComponent(code)));
            
            const options = {
                method: 'POST',
                headers: {
                    'content-type': 'application/json',
                    'X-RapidAPI-Key': '79dfa15cbdmsh8031319b3d7e30ep18a717jsn3d23dbcea455',
                    'X-RapidAPI-Host': 'judge0-ce.p.rapidapi.com'
                },
                body: JSON.stringify({
                    source_code: encodedCode,
                    language_id: language_id,
                    stdin: '',
                    expected_output: ''
                })
            };
            
            try {
                const response = await fetch('https://judge0-ce.p.rapidapi.com/submissions?base64_encoded=true&wait=false', options);
                const data = await response.json();
                return data.token;
            } catch (error) {
                console.error('Error submitting code:', error);
                return null;
            }
        }
        
        // Funkcja do oczekiwania na wynik wykonania kodu
        async function getJudge0Result(token) {
            const options = {
                method: 'GET',
                headers: {
                    'X-RapidAPI-Key': '79dfa15cbdmsh8031319b3d7e30ep18a717jsn3d23dbcea455',
                    'X-RapidAPI-Host': 'judge0-ce.p.rapidapi.com'
                }
            };
            
            let attempts = 0;
            while (attempts < 10) {  // Maksymalnie 10 prób
                try {
                    const response = await fetch(`https://judge0-ce.p.rapidapi.com/submissions/${token}?base64_encoded=true`, options);
                    const data = await response.json();
                    
                    if (data.status && (data.status.id >= 3)) {  // Status 3 i wyżej oznacza zakończenie wykonania
                        // Dekodowanie wyników
                        if (data.stdout) {
                            data.stdout = decodeURIComponent(escape(atob(data.stdout)));
                        }
                        if (data.stderr) {
                            data.stderr = decodeURIComponent(escape(atob(data.stderr)));
                        }
                        if (data.compile_output) {
                            data.compile_output = decodeURIComponent(escape(atob(data.compile_output)));
                        }
                        return data;
                    }
                    
                    // Jeśli wykonanie jeszcze trwa, poczekaj przed następną próbą
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    attempts++;
                } catch (error) {
                    console.error('Error getting results:', error);
                    attempts++;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            
            return null;  // Przekroczono limit prób
        }
        
        // Funkcja do wywołania AI do analizy kodu
        async function getAICodeAnalysis(code, testResults, success) {
            const useProxy = apiMode === 'proxy';
            
            // Sprawdź czy mamy potrzebne dane
            if (!useProxy && !apiKey[aiProvider]) {
                return "Podłącz swój klucz API, aby uzyskać analizę kodu.";
            }
            
            if (useProxy && !proxyUrl) {
                return "Podaj adres URL proxy, aby uzyskać analizę kodu.";
            }
            
            // Wspólny prompt dla obu dostawców
            const prompt = `Jestem programistą uczącym się Pythona. Analizuję następujący kod rozwiązujący zadanie manipulacji tekstu:
            
Zadanie:
Napisz funkcję, która przetwarza tekst według następujących zasad:
- Wszystkie samogłoski (a, e, i, o, u) muszą być zamienione na wielkie litery
- Wszystkie spółgłoski muszą być zamienione na małe litery
- Znaki interpunkcyjne powinny zostać usunięte
- Spacje powinny pozostać nienaruszone
- Jeśli przetwarzany jest plik, rozszerzenie pliku nie powinno być modyfikowane

Moje rozwiązanie:
\`\`\`python
${code}
\`\`\`

Wyniki testów:
${testResults}

Testy ${success ? 'przeszły pomyślnie' : 'nie przeszły'}.

Proszę o analizę mojego kodu. Co zrobiłem dobrze, a co mógłbym poprawić? Uwzględnij:
1. Jakość i czytelność kodu
2. Wydajność
3. Poprawność rozwiązania
4. Potencjalne usprawnienia

Nie sugeruj dodawania komentarzy, kod powinien sam się wyjaśniać.`;
            
            try {
                let response;
                
                if (useProxy) {
                    // Wywołanie przez proxy
                    let payload;
                    if (aiProvider === 'anthropic') {
                        payload = {
                            model: "claude-3-7-sonnet-20250219",
                            max_tokens: 1000,
                            messages: [
                                {role: "user", content: prompt}
                            ]
                        };
                    } else {
                        payload = {
                            model: "gpt-3.5-turbo",
                            messages: [
                                {role: "system", content: "Jesteś doświadczonym nauczycielem programowania w Pythonie, który analizuje kod uczniów."},
                                {role: "user", content: prompt}
                            ],
                            max_tokens: 1000
                        };
                    }
                    
                    response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ provider: aiProvider, payload: payload })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || 'Błąd API');
                    }
                    
                    // Różne formaty odpowiedzi w zależności od dostawcy
                    if (aiProvider === 'anthropic') {
                        return data.content[0].text;
                    } else {
                        return data.choices[0].message.content;
                    }
                } else {
                    // Bezpośrednie wywołanie API
                    if (aiProvider === 'anthropic') {
                        response = await fetch('https://api.anthropic.com/v1/messages', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': apiKey.anthropic,
                                'anthropic-version': '2023-06-01'
                            },
                            body: JSON.stringify({
                                model: "claude-3-7-sonnet-20250219",
                                max_tokens: 1000,
                                messages: [
                                    {role: "user", content: prompt}
                                ]
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message || 'Błąd API Anthropic');
                        }
                        
                        return data.content[0].text;
                    } else {
                        response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey.openai}`
                            },
                            body: JSON.stringify({
                                model: "gpt-3.5-turbo",
                                messages: [
                                    {role: "system", content: "Jesteś doświadczonym nauczycielem programowania w Pythonie, który analizuje kod uczniów."},
                                    {role: "user", content: prompt}
                                ],
                                max_tokens: 1000
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message || 'Błąd API OpenAI');
                        }
                        
                        return data.choices[0].message.content;
                    }
                }
            } catch (error) {
                console.error('Error calling AI API:', error);
                return `Wystąpił błąd podczas analizy kodu: ${error.message}`;
            }
        }
        
        // Funkcja do wysyłania wiadomości do czatu AI
        async function sendChatMessage(message) {
            const useProxy = apiMode === 'proxy';
            
            // Sprawdź czy mamy potrzebne dane
            if (!useProxy && !apiKey[aiProvider]) {
                alert("Podłącz swój klucz API, aby korzystać z czatu AI.");
                return;
            }
            
            if (useProxy && !proxyUrl) {
                alert("Podaj adres URL proxy, aby korzystać z czatu AI.");
                return;
            }
            
            const chatMessages = document.getElementById('chat-messages');
            const userMessage = document.createElement('div');
            userMessage.className = 'chat-message message-user';
            userMessage.innerHTML = `<p>${message}</p>`;
            chatMessages.appendChild(userMessage);
            
            // Dodaj wiadomość ładowania
            const loadingMessage = document.createElement('div');
            loadingMessage.className = 'chat-message message-ai';
            loadingMessage.innerHTML = '<div class="loader"></div> AI generuje odpowiedź...';
            chatMessages.appendChild(loadingMessage);
            
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            try {
                // Dodaj kontekst zadania do wiadomości
                const codeContext = editor.getValue();
                const contextMessage = `Kontekst: Pracuję nad zadaniem gdzie muszę zaimplementować funkcję odwroc_wokalizacje, która przetwarza tekst, zamieniając samogłoski na wielkie litery, spółgłoski na małe, usuwa znaki interpunkcyjne i zachowuje spacje. Aktualny kod:\n\n${codeContext}\n\nMoje pytanie: ${message}`;
                
                let response;
                
                if (useProxy) {
                    // Wywołanie przez proxy
                    let payload;
                    if (aiProvider === 'anthropic') {
                        payload = {
                            model: "claude-3-7-sonnet-20250219",
                            max_tokens: 1000,
                            messages: [
                                {role: "user", content: contextMessage}
                            ]
                        };
                    } else {
                        payload = {
                            model: "gpt-3.5-turbo",
                            messages: [
                                {role: "system", content: "Jesteś pomocnym asystentem uczenia się Pythona, który pomaga studentowi w rozwiązywaniu zadań programistycznych."},
                                {role: "user", content: contextMessage}
                            ],
                            max_tokens: 1000
                        };
                    }
                    
                    response = await fetch(proxyUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ provider: aiProvider, payload: payload })
                    });
                    
                    if (!response.ok) {
                        if (response.status === 429) {
                            throw new Error('Przekroczono limit zapytań. To platforma testowa. Wróć za parę godzin.');
                        }
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    if (data.error) {
                        throw new Error(data.error.message || 'Błąd API');
                    }
                    
                    // Użyj tego:
                    const messageContent = aiProvider === 'anthropic' ? data.content[0].text : data.choices[0].message.content;

                    // Funkcja pomocnicza do escapowania HTML
                    function escapeHtml(text) {
                        return text
                            .replace(/&/g, "&amp;")
                            .replace(/</g, "&lt;")
                            .replace(/>/g, "&gt;")
                            .replace(/"/g, "&quot;")
                            .replace(/'/g, "&#039;");
                    }

                    // Przetwarzanie bloków kodu
                    let formattedContent = messageContent.replace(/```([\w]*)\n([\s\S]*?)```/g, function(match, language, code) {
                        // Escapuj HTML w kodzie i zachowaj znaki nowej linii
                        return `<div class="code-block">
                                    <div class="code-header">
                                        <span>${language || 'kod'}</span>
                                    </div>
                                    <pre><code class="${language || ''}">${escapeHtml(code)}</code></pre>
                                </div>`;
                    });

                    // Zamień znaki nowej linii na <br> tylko w zwykłym tekście (poza blokami kodu)
                    let parts = formattedContent.split(/<div class="code-block">|<\/pre><\/div>/);
                    for (let i = 0; i < parts.length; i++) {
                        // Części o parzystych indeksach to zwykły tekst
                        if (i % 2 === 0) {
                            parts[i] = parts[i].replace(/\n/g, '<br>');
                        }
                    }
                    formattedContent = parts.join('');

                    loadingMessage.innerHTML = `<div class="ai-content">${formattedContent}</div>`;

                    // Podświetl składnię kodu
                    loadingMessage.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightBlock(block);
                    });
                    console.log("code")
// Dodaj nasłuchiwacze zdarzeń dla przycisków kopiowania
loadingMessage.querySelectorAll('.copy-btn').forEach(button => {
    button.addEventListener('click', function() {
        const codeBlock = this.parentElement.nextElementSibling;
        const code = codeBlock.textContent;
        
        navigator.clipboard.writeText(code).then(() => {
            const originalText = this.textContent;
            this.textContent = 'Skopiowano!';
            this.disabled = true;
            
            setTimeout(() => {
                this.textContent = originalText;
                this.disabled = false;
            }, 2000);
        }).catch(err => {
            console.error('Błąd kopiowania:', err);
        });
    });
});
                } else {
                    // Bezpośrednie wywołanie API
                    if (aiProvider === 'anthropic') {
                        response = await fetch('https://api.anthropic.com/v1/messages', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'x-api-key': apiKey.anthropic,
                                'anthropic-version': '2023-06-01'
                            },
                            body: JSON.stringify({
                                model: "claude-3-7-sonnet-20250219",
                                max_tokens: 1000,
                                messages: [
                                    {role: "user", content: contextMessage}
                                ]
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message || 'Błąd API Anthropic');
                        }
                        
                        loadingMessage.innerHTML = `<p>${data.content[0].text.replace(/\n/g, '<br>')}</p>`;
                    } else {
                        response = await fetch('https://api.openai.com/v1/chat/completions', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${apiKey.openai}`
                            },
                            body: JSON.stringify({
                                model: "gpt-3.5-turbo",
                                messages: [
                                    {role: "system", content: "Jesteś pomocnym asystentem uczenia się Pythona, który pomaga studentowi w rozwiązywaniu zadań programistycznych."},
                                    {role: "user", content: contextMessage}
                                ],
                                max_tokens: 1000
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (data.error) {
                            throw new Error(data.error.message || 'Błąd API OpenAI');
                        }
                        
                        loadingMessage.innerHTML = `<p>${data.choices[0].message.content.replace(/\n/g, '<br>')}</p>`;
                    }
                }
                
                chatMessages.scrollTop = chatMessages.scrollHeight;
            } catch (error) {
                console.error('Error sending message to AI:', error);
                loadingMessage.innerHTML = `<p>Wystąpił błąd: ${error.message}</p>`;
            }
        }
        
        // Obsługa chatu
        const chatInput = document.getElementById('chat-input');
        const chatSendButton = document.getElementById('chat-send');
        
        chatSendButton.addEventListener('click', () => {
            const message = chatInput.value.trim();
            if (message) {
                sendChatMessage(message);
                chatInput.value = '';
            }
        });
        
        chatInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                chatSendButton.click();
            }
        });       
        chatInput.addEventListener('focus', () => {
            const aiSidebar = document.querySelector('.ai-sidebar');
            aiSidebar.style.height = 'calc(100vh - 100px)';
            chatInput.rows = 5;
        });

        chatInput.addEventListener('blur', () => {
            if (chatInput.value.trim() === '') {
                const aiSidebar = document.querySelector('.ai-sidebar');
                aiSidebar.style.height = 'calc(100vh - 150px)';
                chatInput.rows = 3;
            }
        });

        // Funkcja do wykonania testów
        async function runTests() {
            const code = editor.getValue();
            const tests = testsEditor.getValue();
            const testOutput = document.getElementById('test-output');
            testOutput.classList.remove('hidden');
            
            // Pokazanie loadera
            testOutput.innerHTML = '<div class="loader"></div> Wykonywanie testów...';
            
            // Przygotowanie pełnego skryptu z kodem i testami
            const fullScript = `${code}\n\n${tests}\n\n# Run tests\nif __name__ == '__main__':\n    unittest.main()`;
            
            try {
                // Przesłanie kodu z testami do Judge0
                const token = await submitToJudge0(fullScript);
                if (!token) {
                    testOutput.innerHTML = '<div class="test-result test-failure">❌ Błąd podczas przesyłania kodu</div>';
                    await showAIReview(false, "Błąd podczas przesyłania kodu");
                    return;
                }
                
                // Oczekiwanie na wyniki wykonania
                const result = await getJudge0Result(token);
                if (!result) {
                    testOutput.innerHTML = '<div class="test-result test-failure">❌ Nie udało się pobrać wyników wykonania</div>';
                    await showAIReview(false, "Nie udało się pobrać wyników wykonania");
                    return;
                }
                
                // Analiza wyników
                let outputContent = '';
                let testResults = '';
                let testSuccess = false;
                
                if (result.stderr) {
                    // Sprawdzenie czy są błędy składniowe
                    if (result.stderr.includes('SyntaxError')) {
                        outputContent += `<div class="test-result test-failure">❌ Błąd składni: ${result.stderr}</div>`;
                        testResults = `Błąd składni: ${result.stderr}`;
                    } 
                    // Analiza wyniku testów unittest
                    else if (result.stderr.includes('FAILED')) {
                        const lines = result.stderr.split('\n');
                        const failedTests = [];
                        const errorTests = [];
                        
                        for (const line of lines) {
                            if (line.includes('FAIL:')) {
                                failedTests.push(line);
                            } else if (line.includes('ERROR:')) {
                                errorTests.push(line);
                            }
                        }
                        
                        for (const test of failedTests) {
                            outputContent += `<div class="test-result test-failure">❌ ${test}</div>`;
                            testResults += `${test}\n`;
                        }
                        
                        for (const test of errorTests) {
                            outputContent += `<div class="test-result test-failure">❌ ${test}</div>`;
                            testResults += `${test}\n`;
                        }
                        
                        // Dodaj szczegóły błędów
                        const errorDetails = result.stderr.split('======================================================================');
                        for (let i = 1; i < errorDetails.length; i++) {
                            outputContent += `<div class="test-result test-failure"><pre>${errorDetails[i]}</pre></div>`;
                            testResults += `${errorDetails[i]}\n`;
                        }
                    } 
                    else {
                        outputContent += `<div class="test-result test-failure">❌ Błąd: ${result.stderr}</div>`;
                        testResults = `Błąd: ${result.stderr}`;
                    }
                }
                
                if (result.stdout) {
                    if (result.stdout.includes('OK')) {
                        outputContent += '<div class="test-result test-success">✅ Wszystkie testy przeszły pomyślnie!</div>';
                        testResults = 'Wszystkie testy przeszły pomyślnie!';
                        testSuccess = true;
                    } else {
                        outputContent += `<pre>${result.stdout}</pre>`;
                        testResults = result.stdout;
                    }
                }
                
                // Jeśli nie ma ani stdout ani stderr, coś poszło nie tak
                if (!result.stdout && !result.stderr) {
                    outputContent += '<div class="test-result test-failure">❌ Brak wyniku wykonania</div>';
                    testResults = 'Brak wyniku wykonania';
                    if (result.compile_output) {
                        outputContent += `<div class="test-result test-failure">Błąd kompilacji: ${result.compile_output}</div>`;
                        testResults += `\nBłąd kompilacji: ${result.compile_output}`;
                    }
                }
                
                testOutput.innerHTML = outputContent;
                await showAIReview(testSuccess, testResults);
            } catch (error) {
                console.error('Error in runTests:', error);
                testOutput.innerHTML = `<div class="test-result test-failure">❌ Wystąpił błąd: ${error.message}</div>`;
                await showAIReview(false, `Wystąpił błąd: ${error.message}`);
            }
        }
        
        // Funkcja do uruchomienia kodu bez testów
        async function runCode() {
            const code = editor.getValue();
            const output = document.getElementById('output');
            output.classList.remove('hidden');
            
            // Pokazanie loadera
            output.innerHTML = '<div class="loader"></div> Wykonywanie kodu...';
            
            // Testowy przypadek - z kontrolą wszystkich testów i ich powodzenia
            const testCase = `
# Funkcja do testowania wyniku
def test_case(input_str, expected, test_name):
    result = odwroc_wokalizacje(input_str)
    status = "PASS" if result == expected else "FAIL"
    status_class = "status-pass" if result == expected else "status-fail"
    print(f'<span class="test-status {status_class}">{status}</span> {test_name}: "{input_str}" → "{result}" {"==" if result == expected else "!="} "{expected}"')
    return result == expected

# Wykonanie wszystkich testów
print("<div class='test-result test-success'>")
test_results = []
test_results.append(test_case("Hello, World!", "hEllO wOrld", "Test 1: Podstawowy"))
test_results.append(test_case("Python 3.9", "pythOn 39", "Test 2: Liczby"))
test_results.append(test_case("example.txt", "ExAmplE.txt", "Test 3: Rozszerzenie pliku"))
test_results.append(test_case("UPPERCASE", "UppErcAsE", "Test 4: Wielkie litery"))
test_results.append(test_case("lowercase", "lOwErcAsE", "Test 5: Małe litery"))
test_results.append(test_case("Mixed-Case!", "mIxEdcAsE", "Test 6: Mieszane z interpunkcją"))

if all(test_results):
    print("\\n✅ WSZYSTKIE TESTY PRZESZŁY POMYŚLNIE!")
else:
    print("\\n❌ NIEKTÓRE TESTY NIE PRZESZŁY.")
print("</div>")
`;
            
            const fullScript = `${code}\n\n${testCase}`;
            
            try {
                // Przesłanie kodu do Judge0
                const token = await submitToJudge0(fullScript);
                if (!token) {
                    output.innerHTML = '<div class="test-result test-failure">❌ Błąd podczas przesyłania kodu</div>';
                    await showAIReview(false, "Błąd podczas przesyłania kodu");
                    return;
                }
                
                // Oczekiwanie na wyniki wykonania
                const result = await getJudge0Result(token);
                if (!result) {
                    output.innerHTML = '<div class="test-result test-failure">❌ Nie udało się pobrać wyników wykonania</div>';
                    await showAIReview(false, "Nie udało się pobrać wyników wykonania");
                    return;
                }
                
                // Analiza wyników
                let outputContent = '';
                let testResults = '';
                let allTestsPassed = false;
                
                if (result.stderr) {
                    outputContent += `<div class="test-result test-failure">❌ Błąd: ${result.stderr}</div>`;
                    testResults = `Błąd: ${result.stderr}`;
                }
                
                if (result.stdout) {
                    outputContent += result.stdout;
                    testResults = result.stdout.replace(/<[^>]*>/g, ''); // Usunięcie tagów HTML z testResults
                    // Sprawdzenie czy wszystkie testy przeszły
                    allTestsPassed = result.stdout.includes("WSZYSTKIE TESTY PRZESZŁY POMYŚLNIE");
                }
                
                // Jeśli nie ma ani stdout ani stderr, coś poszło nie tak
                if (!result.stdout && !result.stderr) {
                    outputContent += '<div class="test-result test-failure">❌ Brak wyniku wykonania</div>';
                    testResults = 'Brak wyniku wykonania';
                    if (result.compile_output) {
                        outputContent += `<div class="test-result test-failure">Błąd kompilacji: ${result.compile_output}</div>`;
                        testResults += `\nBłąd kompilacji: ${result.compile_output}`;
                    }
                }
                
                output.innerHTML = outputContent;
                await showAIReview(allTestsPassed, testResults);
            } catch (error) {
                console.error('Error in runCode:', error);
                output.innerHTML = `<div class="test-result test-failure">❌ Wystąpił błąd: ${error.message}</div>`;
                await showAIReview(false, `Wystąpił błąd: ${error.message}`);
            }
        }
        
        // Funkcja do sprawdzania linta
        async function lintCode() {
            const code = editor.getValue();
            const output = document.getElementById('output');
            output.classList.remove('hidden');
            
            // Pokazanie loadera
            output.innerHTML = '<div class="loader"></div> Sprawdzanie linta...';
            
            // Skrypt do przeprowadzenia lintingu
            const lintScript = `
import sys
import re

def check_syntax(code):
    try:
        compile(code, '<string>', 'exec')
        return True
    except SyntaxError as e:
        print(f"Błąd składni: {str(e)}")
        return False

def check_typing(code):
    issues = []
    
    # Funkcja musi być zaimplementowana, nie może być tylko "pass"
    if 'pass' in code and not re.search(r'def\\s+odwroc_wokalizacje.*[^pass]', code):
        issues.append("Funkcja nie została zaimplementowana (znaleziono tylko 'pass')")
    
    return issues

def check_implementation(code):
    issues = []
    
    # Sprawdzenie czy kod już zawiera działającą implementację
    if not 'pass' in code or code.count('pass') == 0:
        # Sprawdzenie czy używane są wymagane koncepcje
        required_concepts = {
            'SAMOGLOSKI': "Nie używasz zdefiniowanej stałej SAMOGLOSKI",
            'ROZSZERZENIA': "Nie używasz zdefiniowanej stałej ROZSZERZENIA dla sprawdzania rozszerzeń plików"
        }
        
        for concept, message in required_concepts.items():
            if concept not in code or code.count(concept) <= 1:  # Tylko definicja, bez użycia
                issues.append(message)
    
    return issues

code = """${code.replace(/"/g, '\\"').replace(/\n/g, '\\n')}"""

if not code or code.strip() == "":
    print("Kod jest pusty")
    sys.exit(1)

syntax_valid = check_syntax(code)

# W szablonie (na czysto) nie sprawdzamy wszystkich warunków
if 'pass' in code and code.count('SAMOGLOSKI') <= 1:
    print("✅ Szablon kodu jest poprawny. Teraz zaimplementuj funkcję odwroc_wokalizacje!")
    sys.exit(0)

typing_issues = check_typing(code)
impl_issues = check_implementation(code)

all_issues = typing_issues + impl_issues

if not syntax_valid:
    sys.exit(1)

if all_issues:
    for issue in all_issues:
        print(f"- {issue}")
    sys.exit(1)
else:
    print("✅ Kod przeszedł sprawdzenie lintera")
`;
            
            try {
                // Przesłanie skryptu lintującego do Judge0
                const token = await submitToJudge0(lintScript);
                if (!token) {
                    output.innerHTML = '<div class="test-result test-failure">❌ Błąd podczas przesyłania kodu</div>';
                    return;
                }
                
                // Oczekiwanie na wyniki wykonania
                const result = await getJudge0Result(token);
                if (!result) {
                    output.innerHTML = '<div class="test-result test-failure">❌ Nie udało się pobrać wyników sprawdzenia</div>';
                    return;
                }
                
                // Analiza wyników
                let outputContent = '';
                
                if (result.stderr) {
                    outputContent += `<div class="test-result test-failure">❌ Błąd podczas lintowania: ${result.stderr}</div>`;
                }
                
                if (result.stdout) {
                    if (result.stdout.includes("✅")) {
                        outputContent += `<div class="test-result test-success">${result.stdout}</div>`;
                    } else {
                        outputContent += `<div class="test-result lint-error">❌ Problemy z kodem:\n${result.stdout}</div>`;
                    }
                }
                
                // Jeśli nie ma ani stdout ani stderr, coś poszło nie tak
                if (!result.stdout && !result.stderr) {
                    outputContent += '<div class="test-result test-failure">❌ Brak wyniku sprawdzenia</div>';
                    if (result.compile_output) {
                        outputContent += `<div class="test-result test-failure">Błąd: ${result.compile_output}</div>`;
                    }
                }
                
                output.innerHTML = outputContent;
            } catch (error) {
                console.error('Error in lintCode:', error);
                output.innerHTML = `<div class="test-result test-failure">❌ Wystąpił błąd: ${error.message}</div>`;
            }
        }
        
        // Wyświetlanie analizy AI po rozwiązaniu
// Funkcja wyświetlająca analizy AI po rozwiązaniu
async function showAIReview(success, testResults) {
    const aiReviewContent = document.getElementById('ai-review-content');
    const code = editor.getValue();
    
    // Pokazanie loadera w sekcji analizy
    aiReviewContent.innerHTML = '<div class="loader"></div> AI analizuje twój kod...';
    
    // Jeśli kod zawiera tylko pass, to pokazujemy domyślne wskazówki
    if (code.includes('pass') && !code.includes('return')) {
        aiReviewContent.innerHTML = `
            <p>Zaimplementuj funkcję <code>odwroc_wokalizacje</code> zgodnie z wymaganiami zadania.</p>
            <p>Pamiętaj o następujących zasadach:</p>
            <ul>
                <li>Wszystkie samogłoski (a, e, i, o, u) muszą być zamienione na wielkie litery</li>
                <li>Wszystkie spółgłoski muszą być zamienione na małe litery</li>
                <li>Znaki interpunkcyjne powinny zostać usunięte</li>
                <li>Spacje powinny pozostać nienaruszone</li>
                <li>Jeśli przetwarzany jest plik, rozszerzenie pliku nie powinno być modyfikowane</li>
            </ul>
            <p>Kiedy zaimplementujesz rozwiązanie, uruchom kod, aby sprawdzić czy działa poprawnie.</p>
        `;
        return;
    }
    
    // Pobierz analizę kodu z AI API
    try {
        const analysis = await getAICodeAnalysis(code, testResults, success);
        
        // Funkcja pomocnicza do escapowania HTML
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Przetwarzanie bloków kodu
        let formattedContent = analysis.replace(/```([\w]*)\n([\s\S]*?)```/g, function(match, language, code) {
            // Escapuj HTML w kodzie i zachowaj znaki nowej linii
            return `<div class="code-block">
                        <div class="code-header">
                            <span>${language || 'kod'}</span>
                        </div>
                        <pre><code class="${language || ''}">${escapeHtml(code)}</code></pre>
                    </div>`;
        });
        
        // Zamień znaki nowej linii na <br> tylko w zwykłym tekście (poza blokami kodu)
        let parts = formattedContent.split(/<div class="code-block">|<\/pre><\/div>/);
        for (let i = 0; i < parts.length; i++) {
            // Części o parzystych indeksach to zwykły tekst
            if (i % 2 === 0) {
                parts[i] = parts[i].replace(/\n/g, '<br>');
            }
        }
        formattedContent = parts.join('');
        
        aiReviewContent.innerHTML = `<div class="ai-content">${formattedContent}</div>`;
        
        // Podświetl składnię kodu
        aiReviewContent.querySelectorAll('pre code').forEach((block) => {
            hljs.highlightBlock(block);
        });
    } catch (error) {
        console.error('Error getting AI analysis:', error);
        aiReviewContent.innerHTML = `<p>Wystąpił błąd podczas analizy kodu: ${error.message}</p>`;
    }
}
        
        // Przypisanie funkcji do przycisków
        document.getElementById('run-tests').addEventListener('click', runTests);
        document.getElementById('lint-code').addEventListener('click', lintCode);
        document.getElementById('run-code').addEventListener('click', runCode);
        
        // Inicjalizacja highlight.js dla kodu
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('pre code').forEach((block) => {
                hljs.highlightBlock(block);
            });
            
            // Inicjalizacja statusu API
            updateApiKeyStatus();
        });
// W głównym skrypcie, po inicjalizacji elementów

// Pobierz elementy czatu
const chatMessages = document.getElementById('chat-messages');
const aiSidebar = document.querySelector('.ai-sidebar');

// Rozszerz czat na pełny ekran podczas interakcji
chatInput.addEventListener('focus', expandChat);
chatMessages.addEventListener('mousedown', expandChat); // Do zaznaczania tekstu
chatMessages.addEventListener('touchstart', expandChat); // Dla urządzeń mobilnych

// Zwiń czat, gdy klikniemy poza nim
document.addEventListener('mousedown', function(event) {
    // Sprawdź, czy kliknięcie było poza sekcją czatu
    if (!aiSidebar.contains(event.target) && aiSidebar.classList.contains('fullscreen')) {
        collapseChat();
    }
});

// Dodaj nasłuchiwacze, aby czat zostawał rozszerzony podczas interakcji
chatMessages.addEventListener('scroll', function() {
    // Jeśli użytkownik przewija czat, resetuj timer zwężania
    if (collapseTimer) {
        clearTimeout(collapseTimer);
        collapseTimer = setTimeout(collapseChat, 3000); // 3 sekundy bezczynności
    }
});

// Zmienna do przechowywania timera zwężania
let collapseTimer = null;

// Dodaj nasłuchiwacze dla przewijania i ruchu myszy
chatInput.addEventListener('input', function() {
    // Resetuj timer podczas pisania
    if (collapseTimer) clearTimeout(collapseTimer);
});

chatInput.addEventListener('blur', function() {
    // Po utracie fokusu przez pole tekstowe, ustaw timer zwężania
    if (aiSidebar.classList.contains('fullscreen')) {
        collapseTimer = setTimeout(collapseChat, 3000); // 3 sekundy bezczynności
    }
});

// Anuluj timer, gdy najedzie myszą
aiSidebar.addEventListener('mousemove', function() {
    if (collapseTimer) {
        clearTimeout(collapseTimer);
        collapseTimer = null;
    }
});

// Ustaw timer ponownie, gdy mysz opuści obszar
aiSidebar.addEventListener('mouseleave', function() {
    if (aiSidebar.classList.contains('fullscreen')) {
        collapseTimer = setTimeout(collapseChat, 3000);
    }
});
window.copyCode = function(button) {
    const codeBlock = button.parentElement.nextElementSibling;
    const code = codeBlock.textContent;
    
    navigator.clipboard.writeText(code).then(() => {
        const originalText = button.textContent;
        button.textContent = 'Skopiowano!';
        button.disabled = true;
        
        setTimeout(() => {
            button.textContent = originalText;
            button.disabled = false;
        }, 2000);
    }).catch(err => {
        console.error('Błąd kopiowania:', err);
    });
};
// Funkcja do rozszerzania czatu
function expandChat() {
    const aiSidebar = document.querySelector('.ai-sidebar');
    const mainContent = document.querySelector('.main-content');
    
    if (!aiSidebar.classList.contains('fullscreen')) {
        aiSidebar.classList.add('fullscreen');
        mainContent.style.display = 'none';
        document.body.style.overflow = 'hidden';
        
        // Przewiń czat do dołu
        setTimeout(() => {
            const chatMessages = document.getElementById('chat-messages');
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }, 100);
    }
}

// Funkcja do zwężania czatu
function collapseChat() {
    const aiSidebar = document.querySelector('.ai-sidebar');
    const mainContent = document.querySelector('.main-content');
    
    if (aiSidebar.classList.contains('fullscreen')) {
        aiSidebar.classList.remove('fullscreen');
        mainContent.style.display = 'block';
        document.body.style.overflow = 'auto';
    }
}
// Dodaj przycisk zamykania do ai-sidebar
const closeButton = document.createElement('button');
closeButton.className = 'close-fullscreen';
closeButton.innerHTML = '× Zamknij pełny ekran';
closeButton.title = 'Zamknij pełny ekran';
aiSidebar.appendChild(closeButton);
// Zmień styl przycisku zamykania, żeby był zawsze widoczny podczas pełnoekranowego trybu
closeButton.style.position = 'fixed';
closeButton.style.top = '15px';
closeButton.style.right = '15px';
closeButton.style.zIndex = '1002'; // Wyższy z-indexx

// Dodaj nasłuchiwacz dla przycisku zamykania
closeButton.addEventListener('click', function() {
    collapseChat();
});

// Dodaj obsługę klawisza Escape do zamykania pełnego ekranu
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && aiSidebar.classList.contains('fullscreen')) {
        collapseChat();
    }
});
    </script>
</body>
</html>